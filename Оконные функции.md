# Функции ранжирования  
<br>

## RANK  
Перед нами задача, составить рейтинг фильмов за декабрь 1990 г. по продолжительности.
<br>

**Было**
``` 
Title                              |Genre      |Duration|
-----------------------------------+-----------+--------+
Man forward.                       |Adventure  |     179|
Phone door.                        |Action     |     178|
Hot recently trip.                 |Comedy     |     178|
Future say bad.                    |Thriller   |     176|
From look.                         |Horror     |     176|
Question myself.                   |Fantasy    |     176|
Hour image special.                |Fantasy    |     173|
What boy.                          |Sci-Fi     |     172|
Democrat front.                    |Sci-Fi     |     168|
Point point.                       |Sci-Fi     |     163|
Yourself fear admit.               |Documentary|     163|
Message from.                      |Adventure  |     160|
Mother computer.                   |Fantasy    |     158|
Particular outside easy.           |Thriller   |     153|
Open participant painting practice.|Adventure  |     151|
Rest join upon.                    |Documentary|     151|
```
<br>

**Стало**
```
RANK|Title                              |Genre      |Duration
----+-----------------------------------+-----------+--------
   1|Man forward.                       |Adventure  |     179
   2|Phone door.                        |Action     |     178
   2|Hot recently trip.                 |Comedy     |     178
   4|Future say bad.                    |Thriller   |     176
   4|From look.                         |Horror     |     176
   4|Question myself.                   |Fantasy    |     176
   7|Hour image special.                |Fantasy    |     173
   8|What boy.                          |Sci-Fi     |     172
   9|Democrat front.                    |Sci-Fi     |     168
  10|Point point.                       |Sci-Fi     |     163
  10|Yourself fear admit.               |Documentary|     163
  12|Message from.                      |Adventure  |     160
  13|Mother computer.                   |Fantasy    |     158
  14|Particular outside easy.           |Thriller   |     153
  15|Open participant painting practice.|Adventure  |     151
  15|Rest join upon.                    |Documentary|     151
```
Обратите внимание, что фильмы с одинаковой продолжительностью получили один и тот же рейтинг, например, "Phone Door" и "Hot Recently Trip". Чтобы перейти от ```Было``` к ```Стало```, в первую очередь нужно отсортировать таблицу по убыванию продолжительности фильма. Далее нам нужно спускаться вниз построчно и "смотреть" на одно поле — **Duration** (продолжительность). В принципе, мы можем назвать эти значения окном, хотя это и не совсем так, но пока нам этого достаточно. Попробуем описать значения нашего окна: 1) это значения поля **Duration**; 2) они упорядочены по убыванию. Теперь нужно перенести эту логику на **SQL**. Взглянем для начала на запрос без оконной функции.
<br>

**Было**
```
SELECT Title,
       Genre,
       Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 ORDER BY Duration DESC
```
<br>

**Стало**
```
SELECT RANK() OVER (ORDER BY Duration DESC) AS RANK,
       Title,
       Genre,
       Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 ORDER BY RANK, Duration DESC
 ```
В исходную конструкцию мы добавили оконную функцию RANK ``` RANK() OVER (ORDER BY Duration DESC) AS RANK ``` логика которого заключается во второй части конструкции, которая гласит, что значения нашего окна, столбца Duration, мы упорядочили по убыванию.  
___

## DENSE_RANK
Оконные функции ```RANK()``` и ```DENSE_RANK()``` используются для присвоения рангов строкам в наборе данных на основе заданных критериев. Основное отличие между ними заключается в том, как они обрабатывают одинаковые значения.  
Основные отличия:  
* ```RANK()```: Если несколько строк имеют одинаковое значение, они получают одинаковый ранг, но следующий ранг пропускается. Например, если два значения имеют ранг 1, следующий ранг будет 3, а не 2.
* ```DENSE_RANK()```: В случае одинаковых значений, они также получают одинаковый ранг, но следующий ранг не пропускается. То есть, если два значения имеют ранг 1, следующий ранг будет 2.
<br>  

**Запрос**
```
SELECT RANK() OVER (ORDER BY Duration DESC) AS RANK,
       DENSE_RANK() OVER (ORDER BY Duration DESC) AS DENSE_RANK,
       Title,
       Genre,
       Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 ORDER BY RANK, Duration DESC
 LIMIT 15;
```
<br>

**Результат**
```
RANK|DENSE_RANK|Title                              |Genre      |Duration|
----+----------+-----------------------------------+-----------+--------+
   1|         1|Man forward.                       |Adventure  |     179|
   2|         2|Phone door.                        |Action     |     178|
   2|         2|Hot recently trip.                 |Comedy     |     178|
   4|         3|Future say bad.                    |Thriller   |     176|
   4|         3|From look.                         |Horror     |     176|
   4|         3|Question myself.                   |Fantasy    |     176|
   7|         4|Hour image special.                |Fantasy    |     173|
   8|         5|What boy.                          |Sci-Fi     |     172|
   9|         6|Democrat front.                    |Sci-Fi     |     168|
  10|         7|Point point.                       |Sci-Fi     |     163|
  10|         7|Yourself fear admit.               |Documentary|     163|
  12|         8|Message from.                      |Adventure  |     160|
  13|         9|Mother computer.                   |Fantasy    |     158|
  14|        10|Particular outside easy.           |Thriller   |     153|
  15|        11|Open participant painting practice.|Adventure  |     151|
```
<br>  
  
Здесь наглядно показана разница между ```RANK``` и ```DENSE_RANK```, заключающаяся в том, как они обрабатывают одинаковые значения и присваивают последующие ранги.  
  
---

## ORDER BY окна и ORDER BY запроса

Посмотрим на запрос, в котором сортировка задана внутри окна ```(ORDER BY Duration DESC)```, а также отсортирован весь запрос целиком ```ORDER BY```. Почему 2 раза?   
<br>

**Запрос**
```
SELECT DENSE_RANK() OVER (ORDER BY Duration DESC) AS DENSE_RANK,   -- сортировка в окошке
       Title,
	    Genre,
	    Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 ORDER BY DENSE_RANK, Duration DESC   -- сортиовка запроса в целом
 LIMIT 15
```
<br>

**Результат**
```
DENSE_RANK|Title                              |Genre      |Duration|
----------+-----------------------------------+-----------+--------+
         1|Man forward.                       |Adventure  |     179|
         2|Phone door.                        |Action     |     178|
         2|Hot recently trip.                 |Comedy     |     178|
         3|Future say bad.                    |Thriller   |     176|
         3|From look.                         |Horror     |     176|
         3|Question myself.                   |Fantasy    |     176|
         4|Hour image special.                |Fantasy    |     173|
         5|What boy.                          |Sci-Fi     |     172|
         6|Democrat front.                    |Sci-Fi     |     168|
         7|Point point.                       |Sci-Fi     |     163|
         7|Yourself fear admit.               |Documentary|     163|
         8|Message from.                      |Adventure  |     160|
         9|Mother computer.                   |Fantasy    |     158|
        10|Particular outside easy.           |Thriller   |     153|
        11|Open participant painting practice.|Adventure  |     151|
```
<br>  
Оставим сортировку в окне но уберем в основном запросе.   

    
<br>  

**Запрос**
```
SELECT DENSE_RANK() OVER (ORDER BY Duration DESC) AS DENSE_RANK,
       Title,
       Genre,
       Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 LIMIT 15
```
<br>

**Результат**
```
DENSE_RANK|Title                              |Genre      |Duration|
----------+-----------------------------------+-----------+--------+
         1|Man forward.                       |Adventure  |     179|
         2|Phone door.                        |Action     |     178|
         2|Hot recently trip.                 |Comedy     |     178|
         3|Future say bad.                    |Thriller   |     176|
         3|From look.                         |Horror     |     176|
         3|Question myself.                   |Fantasy    |     176|
         4|Hour image special.                |Fantasy    |     173|
         5|What boy.                          |Sci-Fi     |     172|
         6|Democrat front.                    |Sci-Fi     |     168|
         7|Point point.                       |Sci-Fi     |     163|
         7|Yourself fear admit.               |Documentary|     163|
         8|Message from.                      |Adventure  |     160|
         9|Mother computer.                   |Fantasy    |     158|
        10|Particular outside easy.           |Thriller   |     153|
        11|Open participant painting practice.|Adventure  |     151|
```
<br>  

Никаких изменений. Значит второй ```order by``` не нужен? Нужен, сортировка внутри окна, сортирует данные именно внутри окна. Сортировка запроса отрабатывает позже и сортирует весь запрос целиком. Рассмотрим пример. Проранжируем фильмы по убыванию длительности, но сам запрос отсортируем по ее возрастаннию.  
<br>

**Запрос**
```
SELECT DENSE_RANK() OVER (ORDER BY Duration DESC) AS DENSE_RANK,   -- в окне мы сортируем записи по убыванию Duration 
       Title,
       Genre,
       Duration	      
  FROM movies
 WHERE 1 = 1
   AND EXTRACT(YEAR FROM "Release Date") = 1990
   AND EXTRACT(month FROM "Release Date") = 12
 ORDER BY Duration   -- в запросе мы добавляем сортировку по возрастанию длительности
 LIMIT 15
```
<br>

**Результат**
```
DENSE_RANK|Title                 |Genre      |Duration|
----------+----------------------+-----------+--------+
        46|Force every fire.     |Comedy     |      67|
        45|Ago particularly.     |Fantasy    |      70|
        44|Article remain.       |Fantasy    |      75|
        43|Consider service room.|Comedy     |      79|
        42|On either there left. |Comedy     |      86|
        41|Any send.             |Documentary|      87|
        40|Some.                 |Adventure  |      88|
        39|Provide share.        |Drama      |      89|
        39|Perform peace detail. |Horror     |      89|
        38|Behind full.          |Thriller   |      90|
        38|Market shoulder also. |Fantasy    |      90|
        38|Every lay reveal.     |Comedy     |      90|
        37|Authority their.      |Drama      |      91|
        36|Line as.              |Documentary|      92|
        35|I.                    |Thriller   |      93|
```
<br>

Видно, что ранг присвоен по убыванию продолжительности, самые длинные фильмы занимают первые места в ранге, самый короткий фильм на последнем месте и длится 67 минут. А сам запрос отсортирован по возрастанию длительности и на первых строках у нас расположены самые короткие фильмы с постепенным увеличением длительности.  

---

## Однозначность сортировки  

Зачастую возникает вопрос, для каких целей в сортировку добавляют ```id```?
<br>

**Запрос**
```
SELECT DENSE_RABK() OVER (order by salary DESC) AS rank,
       name,
       department,
       salary
  FROM employees
 ORDER BY rank, id;
```
<br>

**Результат**
```
│ rank │   name   │ department │ salary │
├──────┼──────────┼────────────┼────────┤
│ 1    │ Иван     │ it         │ 120    │
│ 2    │ Леонид   │ it         │ 104    │
│ 2    │ Марина   │ it         │ 104    │
│ 3    │ Анна     │ sales      │ 100    │
│ 4    │ Вероника │ sales      │ 96     │
│ 4    │ Григорий │ sales      │ 96     │
│ 5    │ Ксения   │ it         │ 90     │
│ 6    │ Елена    │ it         │ 84     │
│ 7    │ Борис    │ hr         │ 78     │
│ 8    │ Дарья    │ hr         │ 70     │
```
<br>  

Почему используется сортировка по ```rank``` и ```id```, а не только по ```rank```? Это необходимо для того, чтобы правильно упорядочить сотрудников с одинаковым рангом. Без использования ```id``` порядок записей, таких как «Леонид-Марина» и «Вероника-Григорий», остается неопределённым, и система управления базами данных (СУБД) может разместить их в произвольном порядке. Однако при добавлении ```id``` порядок становится однозначным: «Леонид, затем Марина» и «Вероника, затем Григорий».  

___

## Секционирование окна / партиции  

Задача - составить независимый рейтинг внутри каждого жанра.  
<br>  

**Было**
```
Title                              |Genre    |Duration
-----------------------------------+---------+--------
Phone door.                        |Action   |     178
Skin improve.                      |Action   |     120
Fine bed.                          |Action   |     108
Man forward.                       |Adventure|     179
Message from.                      |Adventure|     160
Open participant painting practice.|Adventure|     151
Offer expert.                      |Adventure|     109
Some.                              |Adventure|      88
Hot recently trip.                 |Comedy   |     178
Arm office charge.                 |Comedy   |     122
Full since thought machine.        |Comedy   |     122
Every lay reveal.                  |Comedy   |      90
On either there left.              |Comedy   |      86
Consider service room.             |Comedy   |      79
Force every fire.                  |Comedy   |      67
```
<br>  

**Стало** - разделение дефисами чисто косметическое, для наглядности.
```
Title                              |Genre    |Duration|DENSE_RANK
-----------------------------------+---------+--------+----------
Phone door.                        |Action   |     178|         1
Skin improve.                      |Action   |     120|         2
Fine bed.                          |Action   |     108|         3
-----------------------------------------------------------------
Man forward.                       |Adventure|     179|         1
Message from.                      |Adventure|     160|         2
Open participant painting practice.|Adventure|     151|         3
Offer expert.                      |Adventure|     109|         4
Some.                              |Adventure|      88|         5
-----------------------------------------------------------------
Hot recently trip.                 |Comedy   |     178|         1
Full since thought machine.        |Comedy   |     122|         2
Arm office charge.                 |Comedy   |     122|         2
Every lay reveal.                  |Comedy   |      90|         3
On either there left.              |Comedy   |      86|         4
Consider service room.             |Comedy   |      79|         5
Force every fire.                  |Comedy   |      67|         6
```
